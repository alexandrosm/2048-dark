name: Build and Deploy with Secrets

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create config.js from secrets
        env:
          GA4_ID: ${{ secrets.GA4_ID }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          cat > config.js << EOF
          window.ANALYTICS_CONFIG = {
              GA4_ID: '${GA4_ID:-G-PLACEHOLDER_ID}',
              SENTRY_DSN: '${SENTRY_DSN:-}',
              GA4_DEBUG_MODE: false,
              SENTRY_TRACE_RATE: 0.1
          };
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2